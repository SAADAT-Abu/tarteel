name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Load SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          ssh deploy@$SERVER_IP << 'ENDSSH'
            set -e
            cd /opt/tarteel

            echo "── Pulling latest code ──"
            git pull origin main

            echo "── Rebuilding and restarting services ──"
            docker compose -f docker-compose.prod.yml up -d --build

            echo "── Removing unused Docker images ──"
            docker image prune -f

            echo "── Health check ──"
            sleep 5
            curl -sf https://api.tarteel.live/health && echo " backend OK" || echo " backend not yet ready"

            echo "── Deploy complete ──"
          ENDSSH
