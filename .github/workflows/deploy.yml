name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          # Write the key to a temp file with correct permissions
          echo "$SSH_PRIVATE_KEY" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

          ssh -i /tmp/deploy_key \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              deploy@$SERVER_IP << 'ENDSSH'
            set -e
            cd /opt/tarteel

            echo "── Pulling latest code ──"
            git pull origin main

            echo "── Rebuilding and restarting services ──"
            docker compose -f docker-compose.prod.yml up -d --build

            echo "── Removing unused Docker images ──"
            docker image prune -f

            echo "── Health check ──"
            sleep 5
            curl -sf https://api.tarteel.live/health && echo " backend OK" || echo " backend not yet ready"

            echo "── Deploy complete ──"
          ENDSSH

          rm -f /tmp/deploy_key
