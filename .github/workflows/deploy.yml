name: Deploy to Hetzner

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: SSH deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy
        env:
          SSH_KEY_B64: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          # Decode the base64 key — immune to copy-paste newline corruption
          echo "$SSH_KEY_B64" | base64 -d > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

          # Add server to known hosts
          mkdir -p ~/.ssh
          ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts 2>/dev/null

          ssh -i /tmp/deploy_key deploy@"$SERVER_IP" << 'ENDSSH'
            set -e
            cd /opt/tarteel

            echo "── Pulling latest code ──"
            git pull origin main

            echo "── Rebuilding and restarting services ──"
            docker compose -f docker-compose.prod.yml up -d --build

            echo "── Removing unused Docker images ──"
            docker image prune -f

            echo "── Health check ──"
            sleep 5
            curl -sf https://api.tarteel.live/health && echo " backend OK" || echo " backend not yet ready"

            echo "── Deploy complete ──"
          ENDSSH

          rm -f /tmp/deploy_key
